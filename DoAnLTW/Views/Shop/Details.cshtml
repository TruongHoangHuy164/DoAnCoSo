@model DoAnLTW.Models.Product

@{
    ViewData["Title"] = Model.Name;
}

<div class="container mt-5">
    <div class="row">
        <!-- Hình ảnh sản phẩm -->
        <div class="col-md-6">
            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    @foreach (var image in Model.Images)
                    {
                        <div class="carousel-item @(Model.Images.First() == image ? "active" : "")">
                            <img src="@image.ImageUrl" class="d-block w-100" alt="@Model.Name" style="height: 400px; object-fit: cover;" />
                        </div>
                    }
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>

        <!-- Thông tin sản phẩm -->
        <div class="col-md-6">
            <h2>@Model.Name</h2>
            <p><strong>Thương hiệu:</strong> @Model.Brand.Name</p>
            <p><strong>Danh mục:</strong> @Model.Category.Name</p>
            <p><strong>Mô tả:</strong> @Model.Description</p>
            <p><strong>Tình trạng:</strong> @(Model.TotalStock > 0 ? "Còn hàng" : "Hết hàng")</p>

            <!-- Kích thước và giá -->
            <div class="mb-3">
                <h5>Kích thước:</h5>
                <select id="sizeSelect" class="form-select">
                    @foreach (var productSize in Model.ProductSizes)
                    {
                        <option value="@productSize.SizeId" data-price="@productSize.Price">@productSize.Size.size - @productSize.Price.ToString("N0")đ</option>
                    }
                </select>
            </div>

            <!-- Số lượng và thêm vào giỏ hàng -->
            <div class="mb-3">
                <label for="quantity">Số lượng:</label>
                <input type="number" id="quantity" class="form-control w-25 d-inline-block" value="1" min="1" max="@Model.TotalStock" />
            </div>
            <button class="btn btn-primary" onclick="addToCart(@Model.ProductId)">Thêm vào giỏ hàng</button>
            <button class="btn btn-outline-danger" onclick="addToWishlist(@Model.ProductId)">
                <i class="far fa-heart"></i> Thêm vào yêu thích
            </button>
        </div>
    </div>

    <!-- Đánh giá sản phẩm -->
    <div class="mt-5">
        <h4>Đánh giá sản phẩm</h4>
        @if (Model.Reviews.Any())
        {
            var avgRating = Model.Reviews.Average(r => r.Rating);
            <p><strong>Đánh giá trung bình:</strong> @avgRating.ToString("F1") / 5</p>
            <ul class="list-group">
                @foreach (var review in Model.Reviews.OrderByDescending(r => r.CreatedAt))
                {
                    <li class="list-group-item">
                        <p><strong>Điểm:</strong> @review.Rating / 5</p>
                        <p><strong>Bình luận:</strong> @(string.IsNullOrEmpty(review.Comment) ? "Không có bình luận" : review.Comment)</p>
                        <p><strong>Ngày:</strong> @review.CreatedAt.ToString("dd/MM/yyyy")</p>
                    </li>
                }
            </ul>
        }
        else
        {
            <p>Chưa có đánh giá nào cho sản phẩm này.</p>
        }

        <!-- Form thêm đánh giá -->
        <h5 class="mt-4">Thêm đánh giá của bạn</h5>
        <form asp-action="AddReview" method="post">
            <input type="hidden" name="productId" value="@Model.ProductId" />
            <div class="mb-3">
                <label for="rating">Điểm (1-5):</label>
                <input type="number" name="rating" id="rating" class="form-control w-25" min="1" max="5" required />
            </div>
            <div class="mb-3">
                <label for="comment">Bình luận:</label>
                <textarea name="comment" id="comment" class="form-control" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function addToCart(productId) {
            var sizeId = $('#sizeSelect').val();
            var quantity = $('#quantity').val();

            $.ajax({
                url: '@Url.Action("AddToCart", "Shop")',
                type: 'POST',
                data: { productId: productId, sizeId: sizeId, quantity: quantity },
                success: function () {
                    alert('Đã thêm sản phẩm vào giỏ hàng!');
                    location.reload();
                },
                error: function (xhr) {
                    alert(xhr.responseText || 'Có lỗi xảy ra khi thêm vào giỏ hàng.');
                }
            });
        }

        function addToWishlist(productId) {
            $.ajax({
                url: '@Url.Action("AddToWishlist", "Shop")',
                type: 'POST',
                data: { productId: productId },
                success: function () {
                    alert('Đã thêm sản phẩm vào danh sách yêu thích!');
                    location.reload();
                },
                error: function (xhr) {
                    alert(xhr.responseText || 'Có lỗi xảy ra khi thêm vào danh sách yêu thích.');
                }
            });
        }
    </script>
}