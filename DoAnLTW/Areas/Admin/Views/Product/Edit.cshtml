@model DoAnLTW.Models.Product
@{
    ViewData["Title"] = "Sửa Sản Phẩm";
    Layout = "~/Areas/Admin/Views/Shared/layoutAdmin.cshtml";
    }
<h2>Sửa Sản Phẩm</h2>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

<form asp-action="Edit" method="post" enctype="multipart/form-data">
    <input type="hidden" asp-for="ProductId" />

    <div class="form-group">
        <label asp-for="Name" class="control-label">Tên sản phẩm</label>
        <input asp-for="Name" class="form-control" />
        <span asp-validation-for="Name" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Description" class="control-label">Mô tả</label>
        <textarea asp-for="Description" class="form-control" rows="4"></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="CategoryId" class="control-label">Danh mục</label>
        <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.Categories"></select>
        <span asp-validation-for="CategoryId" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="BrandId" class="control-label">Thương hiệu</label>
        <select asp-for="BrandId" class="form-control" asp-items="ViewBag.Brands"></select>
        <span asp-validation-for="BrandId" class="text-danger"></span>
    </div>

    <!-- Product Sizes -->
    <h4>Kích thước và giá</h4>
    <div id="size-container" class="mb-3">
        @if (Model.ProductSizes != null && Model.ProductSizes.Any())
        {
            for (int i = 0; i < Model.ProductSizes.Count; i++)
            {
                <div class="size-row row mb-2">
                    <div class="col-md-4">
                        <label>Kích thước</label>
                        <select name="selectedSizes[@i]" class="form-control">
                            @foreach (var size in ViewBag.Sizes)
                            {
                                <option value="@size.SizeId" selected="@(size.SizeId == Model.ProductSizes[i].SizeId ? "selected" : null)">@(size.size ?? "Không có tên")</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Số lượng</label>
                        <input type="number" name="sizeQuantities[@i]" class="form-control" value="@Model.ProductSizes[i].Stock" min="0" />
                    </div>
                    <div class="col-md-3">
                        <label>Giá (VNĐ)</label>
                        <input type="number" name="sizePrices[@i]" class="form-control" value="@Model.ProductSizes[i].Price" step="0.01" min="0" />
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger remove-size mt-4">Xóa</button>
                    </div>
                </div>
            }
        }
    </div>
    <button type="button" id="add-size" class="btn btn-primary mb-3">Thêm kích thước</button>

    <!-- Images -->
    <h4>Hình ảnh sản phẩm</h4>
    <div class="form-group">
        <label>Thêm hình ảnh mới</label>
        <input type="file" name="imageFiles" class="form-control-file" multiple accept="image/*" />
    </div>
    <div class="row">
        @if (Model.Images != null && Model.Images.Any())
        {
            foreach (var image in Model.Images)
            {
                <div class="col-md-3 mb-3">
                    <img src="@image.ImageUrl" class="img-fluid" style="max-height: 150px;" alt="Hình ảnh sản phẩm" />
                    <button type="button" class="btn btn-danger btn-sm mt-2 delete-image" data-image-id="@image.Product_ImagesId">Xóa</button>
                </div>
            }
        }
        else
        {
            <p>Chưa có hình ảnh.</p>
        }
    </div>

    <div class="form-group">
        <button type="submit" class="btn btn-primary">Lưu</button>
        <a asp-action="Index" class="btn btn-secondary">Hủy</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function () {
            let sizeIndex = @Model.ProductSizes?.Count ?? 0;

            // Thêm hàng kích thước mới
            $("#add-size").click(function () {
                let sizeOptions = `@foreach (var size in ViewBag.Sizes)
        {
                        <option value="@size.SizeId">@(size.size ?? "Không có tên")</option>
        }`;
                let html = `
                    <div class="size-row row mb-2">
                        <div class="col-md-4">
                            <label>Kích thước</label>
                            <select name="selectedSizes[${sizeIndex}]" class="form-control">
                                ${sizeOptions}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Số lượng</label>
                            <input type="number" name="sizeQuantities[${sizeIndex}]" class="form-control" value="0" min="0" />
                        </div>
                        <div class="col-md-3">
                            <label>Giá (VNĐ)</label>
                            <input type="number" name="sizePrices[${sizeIndex}]" class="form-control" value="0" step="0.01" min="0" />
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger remove-size mt-4">Xóa</button>
                        </div>
                    </div>`;
                $("#size-container").append(html);
                sizeIndex++;
            });

            // Xóa hàng kích thước
            $(document).on("click", ".remove-size", function () {
                $(this).closest(".size-row").remove();
            });

            // Xóa hình ảnh
            $(document).on("click", ".delete-image", function () {
                let imageId = $(this).data("image-id");
                if (confirm("Bạn có chắc muốn xóa hình ảnh này?")) {
                    $.ajax({
                        url: '@Url.Action("DeleteImage", "Product", new { area = "Admin" })',
                        type: 'POST',
                        data: { imageId: imageId },
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (result) {
                            if (result.success) {
                                $(`button[data-image-id="${imageId}"]`).closest(".col-md-3").remove();
                                alert("Xóa hình ảnh thành công!");
                            } else {
                                alert(result.message);
                            }
                        },
                        error: function () {
                            alert("Lỗi khi xóa hình ảnh.");
                        }
                    });
                }
            });
        });
    </script>
}